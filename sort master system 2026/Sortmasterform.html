<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sort Master Form - Sort Master System</title>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f5f5 0%, #e8e0d5 100%);
      font-size: 13px;
      min-height: 100vh;
    }

    /* Top Bar - Light Black */
    .topbar {
      background: linear-gradient(90deg, #2C2C2C 0%, #3a3a3a 100%);
      color: white;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .topbar h1 {
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .topbar-right {
      display: flex;
      gap: 20px;
      align-items: center;
      font-size: 12px;
    }

    .btn-back {
      background: linear-gradient(135deg, #8B6F47 0%, #a07d4f 100%);
      color: white;
      border: none;
      padding: 8px 18px;
      cursor: pointer;
      font-size: 12px;
      border-radius: 5px;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .btn-back:hover {
      background: linear-gradient(135deg, #7a5f3a 0%, #8B6F47 100%);
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(139, 111, 71, 0.4);
    }

    /* Container */
    .container {
      max-width: 100%;
      padding: 20px;
    }

    /* Form Container */
    .form-box {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      /* Animation */
      animation: slideUpFadeIn 0.5s ease-out forwards;
      opacity: 0;
      transform: translateY(30px);
    }

    @keyframes slideUpFadeIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Form Header - Light Brown */
    .form-header {
      background: linear-gradient(90deg, #8B6F47 0%, #a07d4f 100%);
      color: white;
      padding: 16px 24px;
      font-weight: 600;
      font-size: 18px;
      text-align: center;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    /* Form Content */
    .form-content {
      padding: 24px;
    }

    /* Compact Grid - 4 Columns */
    .grid-4 {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px 20px;
      margin-bottom: 20px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px 20px;
      margin-bottom: 20px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px 20px;
      margin-bottom: 20px;
    }

    /* Form Field */
    .field {
      display: flex;
      flex-direction: column;
    }

    .field.span-2 {
      grid-column: span 2;
    }

    .field.span-3 {
      grid-column: span 3;
    }

    .field.span-4 {
      grid-column: span 4;
    }

    .field label {
      font-size: 11px;
      color: #555;
      margin-bottom: 4px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .field label .req {
      color: #D32F2F;
    }

    .field input,
    .field select,
    .field textarea {
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      font-size: 13px;
      background: #fafafa;
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      outline: none;
      border-color: #8B6F47;
      background: white;
      box-shadow: 0 0 0 3px rgba(139, 111, 71, 0.1);
    }

    .field input:hover,
    .field select:hover,
    .field textarea:hover {
      border-color: #bbb;
    }

    .field input.calc,
    .field input:read-only {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      font-weight: 600;
      color: #1565C0;
      border-color: #90CAF9;
    }

    .field textarea {
      resize: vertical;
      min-height: 60px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* Section Divider */
    .section-divider {
      height: 2px;
      background: linear-gradient(90deg, transparent, #8B6F47, transparent);
      margin: 24px 0;
    }

    /* Tables */
    .table-section {
      margin: 24px 0;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .table-header {
      background: linear-gradient(90deg, #2C2C2C 0%, #3a3a3a 100%);
      color: white;
      padding: 12px 16px;
      font-weight: 600;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .table-header::before {
      content: 'üìã';
    }

    .table-wrap {
      overflow-x: auto;
      border: 1px solid #ddd;
      border-top: none;
      background: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      background: linear-gradient(180deg, #3a3a3a 0%, #2C2C2C 100%);
      color: white;
    }

    th {
      padding: 12px 10px;
      text-align: left;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-right: 1px solid #555;
      white-space: nowrap;
    }

    th:last-child {
      border-right: none;
    }

    td {
      padding: 6px 4px;
      border: 1px solid #e0e0e0;
      background: white;
    }

    tbody tr:hover {
      background: #f8f5f0;
    }

    tbody tr:nth-child(even) {
      background: #fafafa;
    }

    tbody tr:nth-child(even):hover {
      background: #f8f5f0;
    }

    table input,
    table select {
      width: 100%;
      padding: 8px 6px;
      border: 1px solid #ddd;
      font-size: 12px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    table input:focus,
    table select:focus {
      border-color: #8B6F47;
      box-shadow: 0 0 0 2px rgba(139, 111, 71, 0.15);
      outline: none;
    }

    table input:read-only {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      font-weight: 600;
      cursor: not-allowed;
      color: #1565C0;
      border-color: #90CAF9;
    }

    /* Auto-fill animation */
    @keyframes autofill-flash {
      0% {
        background-color: #e8f5e9;
        transform: scale(1.02);
      }

      100% {
        background-color: transparent;
        transform: scale(1);
      }
    }

    .auto-filled {
      animation: autofill-flash 0.5s ease;
    }

    .missing-count {
      border: 2px solid #ff9800 !important;
      background: #fff3e0 !important;
    }

    table select {
      height: 32px;
      background: white;
    }

    /* Buttons */
    .btn-add {
      background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 12px;
      border-radius: 4px;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .btn-add:hover {
      background: linear-gradient(135deg, #43A047 0%, #4CAF50 100%);
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(76, 175, 80, 0.4);
    }

    .btn-remove {
      background: linear-gradient(135deg, #F44336 0%, #EF5350 100%);
      color: white;
      border: none;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 12px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .btn-remove:hover {
      background: linear-gradient(135deg, #D32F2F 0%, #F44336 100%);
      transform: scale(1.05);
    }

    .btn-calculate {
      background: linear-gradient(135deg, #2196F3 0%, #42A5F5 100%);
      color: white;
      border: none;
      padding: 12px 28px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .btn-calculate:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
    }

    /* Form Actions */
    .form-actions {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 2px solid #e0e0e0;
    }

    .btn-primary {
      background: linear-gradient(135deg, #8B6F47 0%, #a07d4f 100%);
      color: white;
      border: none;
      padding: 12px 32px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #7a5f3a 0%, #8B6F47 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(139, 111, 71, 0.4);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #FF9800 0%, #FFB74D 100%);
      color: white;
      border: none;
      padding: 12px 32px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, #FB8C00 0%, #FF9800 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
    }

    .btn-cancel {
      background: linear-gradient(135deg, #9E9E9E 0%, #BDBDBD 100%);
      color: white;
      border: none;
      padding: 12px 32px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .btn-cancel:hover {
      background: linear-gradient(135deg, #757575 0%, #9E9E9E 100%);
      transform: translateY(-2px);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Message */
    .message {
      padding: 12px 16px;
      margin-bottom: 16px;
      font-size: 13px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .message.error {
      background: linear-gradient(135deg, #FFEBEE 0%, #FFCDD2 100%);
      color: #C62828;
      border: 1px solid #EF9A9A;
    }

    .message.error::before {
      content: '‚ùå';
    }

    .message.success {
      background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
      color: #2E7D32;
      border: 1px solid #A5D6A7;
    }

    .message.success::before {
      content: '‚úÖ';
    }

    /* Loading */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }

    .loading-overlay.show {
      display: flex;
    }

    .loading-box {
      background: white;
      padding: 20px;
      border-radius: 5px;
      text-align: center;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #8B6F47;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Confirm Modal */
    .confirm-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s ease;
    }

    .confirm-modal-overlay.show {
      display: flex;
    }

    .confirm-modal {
      background: #FAFAFA;
      border-radius: 8px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      width: 90%;
      overflow: hidden;
      animation: slideUp 0.3s ease;
    }

    .confirm-modal-header {
      background: #2C2C2C;
      color: white;
      padding: 15px 20px;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .confirm-modal-header .icon {
      font-size: 20px;
    }

    .confirm-modal-body {
      padding: 25px 20px;
      font-size: 14px;
      color: #333;
      line-height: 1.5;
      background: white;
    }

    .confirm-modal-footer {
      padding: 15px 20px;
      background: #F5F5F5;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      border-top: 1px solid #E0E0E0;
    }

    .modal-btn {
      padding: 10px 24px;
      border: none;
      border-radius: 5px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .modal-btn-confirm {
      background: #8B6F47;
      color: white;
    }

    .modal-btn-confirm:hover {
      background: #7A5F3A;
    }

    .modal-btn-cancel {
      background: #E0E0E0;
      color: #333;
    }

    .modal-btn-cancel:hover {
      background: #D0D0D0;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Responsive */
    @media (max-width: 1400px) {
      .grid-4 {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 1000px) {
      .grid-4 {
        grid-template-columns: repeat(2, 1fr);
      }

      .grid-3 {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 600px) {

      .grid-4,
      .grid-3,
      .grid-2 {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>

  <!-- Top Bar -->
  <div class="topbar">
    <h1>üìä Sort Master System</h1>
    <div class="topbar-right">
      <span>üë§
        <?= user.userName ?>
      </span>
      <button class="btn-back" onclick="goBack()">‚Üê Back</button>
    </div>
  </div>

  <!-- Main Container -->
  <div class="container">
    <div class="form-box">
      <!-- Form Header -->
      <div class="form-header">SORT MASTER INFO</div>

      <!-- Form Content -->
      <div class="form-content">
        <div id="messageArea"></div>

        <!-- Row 1: Basic Info -->
        <div class="grid-4">
          <div class="field">
            <label>Fabric Type<span class="req">*</span></label>
            <select id="fabricType" required>
              <option value="">Select...</option>
              <option value="Grey">Grey</option>
              <option value="Dyed">Dyed</option>
              <option value="Printed">Printed</option>
            </select>
          </div>

          <div class="field">
            <label>Sort No</label>
            <input type="text" id="sortMasterNo" readonly class="calc">
          </div>

          <div class="field">
            <label>Quality Details<span class="req">*</span></label>
            <input type="text" id="qualityDetails" oninput="updateQualitySortNo()">
          </div>

          <div class="field">
            <label>Quality Sort No</label>
            <input type="text" id="qualitySortNo" readonly class="calc" placeholder="Auto-generated">
          </div>
        </div>

        <!-- Row 2: Weave & Create For -->
        <div class="grid-4">
          <div class="field">
            <label>Weave<span class="req">*</span></label>
            <select id="weaveId" required>
              <option value="">Select...</option>
              <!-- Options populated by JavaScript from weaveMasterData -->
            </select>
          </div>

          <div class="field">
            <label>Create For<span class="req">*</span></label>
            <select id="createFor" required>
              <option value="">Select...</option>
              <option value="Domestic">Domestic</option>
              <option value="Export">Export</option>
            </select>
          </div>

          <div class="field">
            <label>RTWE No<span class="req">*</span></label>
            <input type="text" id="rtweNo" required>
          </div>

          <div class="field">
            <label>Broker Name<span class="req">*</span></label>
            <input type="text" id="brokerName" required>
          </div>
        </div>

        <!-- Row 3: Reed & Denting -->
        <div class="grid-4">
          <div class="field">
            <label>Reed<span class="req">*</span></label>
            <input type="number" id="reed" step="0.01" required oninput="triggerAutoCalculate()">
          </div>

          <div class="field">
            <label>Denting<span class="req">*</span></label>
            <input type="number" id="denting" step="0.01" required oninput="triggerAutoCalculate()">
          </div>

          <div class="field">
            <label>Multi-Dents</label>
            <input type="text" id="multiDents" oninput="triggerAutoCalculate()">
          </div>

          <div class="field">
            <label>Final Reed</label>
            <input type="number" id="finalReed" class="calc" readonly>
          </div>
        </div>

        <!-- Row 4: Width & Picks -->
        <div class="grid-4">
          <div class="field">
            <label>Width (Inch/cm)<span class="req">*</span></label>
            <input type="number" id="width" step="0.01" required oninput="triggerAutoCalculate()">
          </div>

          <div class="field">
            <label>Extra Width</label>
            <input type="number" id="extraWidth" step="0.01" value="0" oninput="triggerAutoCalculate()">
          </div>

          <div class="field">
            <label>Picks<span class="req">*</span></label>
            <input type="number" id="picks" required oninput="triggerAutoCalculate()">
          </div>

          <div class="field">
            <label>Reed Space</label>
            <input type="number" id="reedSpace" class="calc" readonly>
          </div>
        </div>

        <!-- Row 5: Total Ends & Pick Insert -->
        <div class="grid-4">
          <div class="field">
            <label>Total Ends</label>
            <input type="number" id="totalEnds" class="calc" readonly>
          </div>

          <div class="field">
            <label>Width(CM)</label>
            <input type="number" id="widthCm" class="calc" readonly>
          </div>

          <div class="field">
            <label>Composition</label>
            <input type="text" id="composition">
          </div>

          <div class="field">
            <label>Pick Insert</label>
            <input type="number" id="pickInsert" step="0.01" value="1" oninput="triggerAutoCalculate()">
          </div>
        </div>

        <!-- Row 6: Size Pickup -->
        <div class="grid-4">
          <div class="field">
            <label>Loom Type</label>
            <input type="text" id="loomType" list="loomTypeList" placeholder="Select or type...">
            <datalist id="loomTypeList">
              <option value="Rapier">
              <option value="Air Jet">
              <option value="Water Jet">
              <option value="Projectile">
            </datalist>
          </div>

          <div class="field">
            <label>Selvedge</label>
            <select id="selvedgeId" onchange="getSelvedgeDetails(this.value)">
              <option value="">Select...</option>
              <!-- Options populated by JavaScript from selvedgeMasterData -->
            </select>
          </div>

          <div class="field">
            <label>Dents + S.Width</label>
            <input type="number" id="dentsWidth" step="0.01" oninput="triggerAutoCalculate()">
          </div>

          <div class="field">
            <label>Size Pick Up %</label>
            <input type="number" id="sizePickup" step="0.01" value="0">
          </div>
        </div>

        <!-- Row 7: Ends & Paper Tube -->
        <div class="grid-4">
          <div class="field">
            <label>Ends per Dent</label>
            <input type="number" id="endsPerDent" step="0.01" oninput="triggerAutoCalculate()">
          </div>

          <div class="field">
            <label>Selvedge Ends</label>
            <input type="number" id="selvedgeEnds" oninput="triggerAutoCalculate()">
          </div>

          <div class="field">
            <label>Ends With Selvedge</label>
            <input type="number" id="endsWithSelvedge" class="calc" readonly>
          </div>

          <div class="field">
            <label>Paper Tube Size</label>
            <input type="text" id="paperTubeSize" list="paperTubeSizeList" placeholder="Select or type...">
            <datalist id="paperTubeSizeList">
              <option value="3 inch">
              <option value="4 inch">
              <option value="6 inch">
            </datalist>
          </div>
        </div>

        <!-- Row 8: Beam & Selvedge Drawing -->
        <div class="grid-4">
          <div class="field">
            <label>Beam Type</label>
            <input type="text" id="beamTypeMain" list="beamTypeMainList" placeholder="Select or type...">
            <datalist id="beamTypeMainList">
              <option value="BOTTOM">
              <option value="TOP">
              <option value="BOBBIN">
            </datalist>
          </div>

          <div class="field">
            <label>Selvedge Drawing</label>
            <input type="text" id="selvedgeDrawing">
          </div>

          <div class="field">
            <label>Master Quality</label>
            <input type="text" id="masterQuality" list="masterQualityList" placeholder="Select or type...">
            <datalist id="masterQualityList">
              <option value="A Grade">
              <option value="B Grade">
              <option value="C Grade">
            </datalist>
          </div>

          <div class="field">
            <label>On Loom</label>
            <input type="text" id="onLoom">
          </div>
        </div>

        <!-- Row 9: Warp/Weft Patterns -->
        <div class="grid-4">
          <div class="field">
            <label>Total Warp Patterns</label>
            <input type="number" id="totalWarpPattern" class="calc" readonly>
          </div>

          <div class="field">
            <label>Total Weft Patterns</label>
            <input type="number" id="totalWeftPattern" class="calc" readonly>
          </div>

          <div class="field">
            <label>Total Warp Grms/Mtr</label>
            <input type="number" id="totalWarpGrms" class="calc" readonly>
          </div>

          <div class="field">
            <label>Total Weft Grms/Mtr</label>
            <input type="number" id="totalWeftGrms" class="calc" readonly>
          </div>
        </div>

        <!-- Row 10: GLM/GSM Calculations -->
        <div class="grid-4">
          <div class="field">
            <label>CAL GLM Without Shrinkage</label>
            <input type="number" id="glmNoShrink" class="calc" readonly>
          </div>

          <div class="field">
            <label>CAL GSM with Shrinkage</label>
            <input type="number" id="gsmWithShrink" class="calc" readonly>
          </div>

          <div class="field">
            <label>CAL GSM without Shrinkage</label>
            <input type="number" id="gsmNoShrink" class="calc" readonly>
          </div>

          <div class="field">
            <label>Display Quality</label>
            <input type="text" id="displayQuality" class="calc" readonly>
          </div>
        </div>

        <!-- Row 11: ACT GLM/GSM -->
        <div class="grid-4">
          <div class="field">
            <label>ACT GLM</label>
            <input type="number" id="actGlm" step="0.01">
          </div>

          <div class="field">
            <label>ACT GSM</label>
            <input type="number" id="actGsm" step="0.01">
          </div>

          <div class="field">
            <label>Peg Plan</label>
            <textarea id="pegPlan" rows="1"></textarea>
          </div>

          <div class="field">
            <label>Drawing</label>
            <textarea id="drawing" rows="1"></textarea>
          </div>
        </div>

        <!-- Row 12: Remark & Checkboxes -->
        <div class="grid-3">
          <div class="field">
            <label>Remark</label>
            <textarea id="remark" rows="2"></textarea>
          </div>

          <div class="field">
            <label>Is Master Quality</label>
            <input type="checkbox" id="isMasterQuality">
          </div>

          <div class="field">
            <label>Selvedge (Yes/No)</label>
            <input type="checkbox" id="hasSelvedge">
          </div>
        </div>

        <!-- Row 13: Images & L2L -->
        <div class="grid-3">
          <div class="field">
            <label>Design Paper Image</label>
            <input type="file" id="designImage" accept="image/*">
          </div>

          <div class="field">
            <label>Fabric Image</label>
            <input type="file" id="fabricImage" accept="image/*">
          </div>

          <div class="field">
            <label>L2L</label>
            <input type="text" id="l2l">
          </div>
        </div>

        <!-- WARP DETAILS TABLE -->
        <div class="table-section">
          <div class="table-header">Warp Details *</div>
          <div class="table-wrap">
            <table id="warpTable">
              <thead>
                <tr>
                  <th>BEAM TYPE</th>
                  <th>PATTERN</th>
                  <th>MATERIAL</th>
                  <th>ENGLISH COUNT</th>
                  <th>SHRINKAGE %</th>
                  <th>TOTAL ENDS</th>
                  <th>GRMS/MTR</th>
                  <th>GRMS NO SHRINK</th>
                  <th>ADD</th>
                  <th>REMOVE</th>
                </tr>
              </thead>
              <tbody id="warpBody">
              </tbody>
            </table>
          </div>
          <button class="btn-add" onclick="addWarpRow()">‚ûï Add Warp Row</button>
        </div>

        <!-- WEFT DETAILS TABLE -->
        <div class="table-section">
          <div class="table-header">Weft Details *</div>
          <div class="table-wrap">
            <table id="weftTable">
              <thead>
                <tr>
                  <th>PATTERN</th>
                  <th>MATERIAL</th>
                  <th>ENGLISH COUNT</th>
                  <th>SHRINKAGE %</th>
                  <th>TOTAL PICKS</th>
                  <th>GRMS/MTR</th>
                  <th>GRMS NO SHRINK</th>
                  <th>ADD</th>
                  <th>REMOVE</th>
                </tr>
              </thead>
              <tbody id="weftBody">
              </tbody>
            </table>
          </div>
          <button class="btn-add" onclick="addWeftRow()">‚ûï Add Weft Row</button>
        </div>

        <!-- HSN SECTION -->
        <div class="grid-4" style="margin-top: 15px;">
          <div class="field">
            <label>HSN Number</label>
            <input type="text" id="hsnNumber" maxlength="8">
          </div>

          <div class="field">
            <label>IGST %</label>
            <input type="number" id="igst" step="0.01" value="0">
          </div>

          <div class="field">
            <label>CGST %</label>
            <input type="number" id="cgst" step="0.01" value="0">
          </div>

          <div class="field">
            <label>SGST %</label>
            <input type="number" id="sgst" step="0.01" value="0">
          </div>
        </div>

        <div class="grid-4">
          <div class="field span-4">
            <label>HSN Description</label>
            <textarea id="hsnDescription" rows="2"></textarea>
          </div>
        </div>

        <!-- Calculate Button - Hidden, calculations are now automatic -->
        <div style="text-align: center; margin: 15px 0; display: none;">
          <button class="btn-calculate" onclick="calculateAll()">üî¢ Calculate All Values</button>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button class="btn-primary" onclick="handleSave(false)" id="btnSave">üíæ Save</button>
          <button class="btn-secondary" onclick="handleSave(true)" id="btnShare">üì§ Save & Share</button>
          <button class="btn-cancel" onclick="goBack()">‚ùå Cancel</button>
        </div>

      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-box">
      <div class="spinner"></div>
      <div id="loadingText">Processing...</div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div class="confirm-modal-overlay" id="confirmModal">
    <div class="confirm-modal">
      <div class="confirm-modal-header">
        <span class="icon">‚ö†Ô∏è</span>
        <span>Confirm Action</span>
      </div>
      <div class="confirm-modal-body">
        <p id="confirmMessage">Are you sure you want to discard all changes?</p>
        <p style="margin-top: 10px; color: #666; font-size: 12px;">This action cannot be undone.</p>
      </div>
      <div class="confirm-modal-footer">
        <button class="modal-btn modal-btn-cancel" onclick="hideConfirmModal()">Cancel</button>
        <button class="modal-btn modal-btn-confirm" id="confirmBtn">Discard</button>
      </div>
    </div>
  </div>

  <script>
    const sessionId = '<?= sessionId ?>';
    const webAppUrl = '<?= webAppUrl ?>';
    const mode = '<?= mode ?>' || 'create';
    const sortMasterId = '<?= sortMasterId ?>' ? '<?= sortMasterId ?>' : null;
    const rtweNoParam = '<?= rtweNo ?>' || '';
    const userId = '<?= user.userId ?>' || '';
    const userName = '<?= user.userName ?>' || '';

    let itemMasterData = [];
    let weaveMasterData = [];
    let selvedgeMasterData = [];
    let warpCounter = 0;
    let weftCounter = 0;
    let isViewMode = (mode === 'view'); // Track view mode globally

    // Initialize
    window.onload = function () {
      loadMasterData();

      if (mode === 'create') {
        previewSortMasterNo();

        // Auto-fill from pending order if RTWE provided
        if (rtweNoParam) {
          loadPendingOrder(rtweNoParam);
        }
        // Note: Initial rows are now added after data loads in checkAllLoaded()
      }
    };

    // Load master data - using google.script.run for GAS web apps
    function loadMasterData() {
      showLoading('Loading data...');
      let loadedCount = 0;
      const totalLoads = 3;

      function checkAllLoaded() {
        loadedCount++;
        if (loadedCount >= totalLoads) {
          hideLoading();
          // Add initial rows AFTER data is loaded (so Material datalist has options)
          if (mode === 'create') {
            addWarpRow();
            addWeftRow();
          } else if (mode === 'view' || mode === 'edit') {
            // Load existing Sort Master data
            loadSortMasterData(sortMasterId);
          }
        }
      }

      // Load Item Master
      google.script.run
        .withSuccessHandler(function (data) {
          if (data.success) {
            itemMasterData = data.items;
          }
          checkAllLoaded();
        })
        .withFailureHandler(function (error) {
          console.error('Error loading items:', error);
          checkAllLoaded();
        })
        .getItemMaster();

      // Load Weave Master
      google.script.run
        .withSuccessHandler(function (data) {
          if (data.success) {
            weaveMasterData = data.weaves;
            populateWeaves();
          }
          checkAllLoaded();
        })
        .withFailureHandler(function (error) {
          console.error('Error loading weaves:', error);
          checkAllLoaded();
        })
        .getWeaveMaster();

      // Load Selvedge Master
      google.script.run
        .withSuccessHandler(function (data) {
          if (data.success) {
            selvedgeMasterData = data.selvedges;
            populateSelvedges();
          }
          checkAllLoaded();
        })
        .withFailureHandler(function (error) {
          console.error('Error loading selvedges:', error);
          checkAllLoaded();
        })
        .getSelvedgeMaster();
    }

    // Populate weave dropdown (select)
    function populateWeaves() {
      const select = document.getElementById('weaveId');
      // Keep the first "Select..." option
      select.innerHTML = '<option value="">Select...</option>';
      weaveMasterData.forEach(w => {
        select.innerHTML += `<option value="${w.weaveName}">${w.weaveName}</option>`;
      });
    }

    // Populate selvedge dropdown (select)
    function populateSelvedges() {
      const select = document.getElementById('selvedgeId');
      // Keep the first "Select..." option
      select.innerHTML = '<option value="">Select...</option>';
      selvedgeMasterData.forEach(s => {
        select.innerHTML += `<option value="${s.id}">${s.name}</option>`;
      });
    }

    // Get selvedge details and auto-fill fields when dropdown selection changes
    function getSelvedgeDetails(selvedgeId) {
      if (!selvedgeId) {
        // If "Select..." is chosen, don't clear fields (allow manual input)
        return;
      }

      // Call backend to get selvedge details
      google.script.run
        .withSuccessHandler(function (selvedge) {
          if (selvedge) {
            // Auto-fill selvedge fields
            document.getElementById('dentsWidth').value = selvedge.width || 0;
            document.getElementById('endsPerDent').value = selvedge.endsPerDent || 0;
            document.getElementById('selvedgeEnds').value = selvedge.ends || 0;

            console.log('‚úÖ Auto-filled selvedge:', selvedge.name);

            // Trigger auto-calculation
            triggerAutoCalculate();
          }
        })
        .withFailureHandler(function (error) {
          console.error('‚ùå Error loading selvedge details:', error);
        })
        .getSelvedgeDetails(selvedgeId);
    }

    // Preview Sort Master No - using google.script.run
    function previewSortMasterNo() {
      google.script.run
        .withSuccessHandler(function (data) {
          if (data.success) {
            document.getElementById('sortMasterNo').value = data.sortMasterNo;
          }
        })
        .withFailureHandler(function (error) {
          console.error('Error previewing sort master no:', error);
        })
        .previewSortMasterNo();
    }

    // Load pending order data - using google.script.run
    function loadPendingOrder(rtweNo) {
      showLoading('Loading order...');

      google.script.run
        .withSuccessHandler(function (data) {
          hideLoading();
          if (data.success && data.order) {
            document.getElementById('rtweNo').value = data.order.rtweNo;
            document.getElementById('brokerName').value = data.order.brokerName;
            document.getElementById('qualityDetails').value = data.order.quality;
          }
        })
        .withFailureHandler(function (error) {
          hideLoading();
          console.error('Error loading pending order:', error);
        })
        .getPendingOrderByRTWE(rtweNo);
    }

    // Load existing Sort Master data for view/edit mode
    function loadSortMasterData(sortMasterId) {
      console.log('loadSortMasterData called with sortMasterId:', sortMasterId, 'type:', typeof sortMasterId);

      if (!sortMasterId) {
        console.error('No sortMasterId provided');
        showMessage('Sort Master ID not provided', 'error');
        return;
      }

      showLoading('Loading Sort Master data...');

      google.script.run
        .withSuccessHandler(function (sortMaster) {
          console.log('=== SUCCESS HANDLER CALLED ===');
          console.log('Raw response:', sortMaster);
          console.log('Type:', typeof sortMaster);
          console.log('Is null?:', sortMaster === null);
          console.log('Is undefined?:', sortMaster === undefined);
          console.log('Is object?:', typeof sortMaster === 'object');

          if (sortMaster) {
            console.log('Has sortMasterNo?:', 'sortMasterNo' in sortMaster);
            console.log('sortMasterNo value:', sortMaster.sortMasterNo);
            console.log('All keys:', Object.keys(sortMaster));
            console.log('First 5 properties:');
            let count = 0;
            for (let key in sortMaster) {
              if (count++ < 5) {
                console.log('  ' + key + ':', sortMaster[key]);
              }
            }
          }

          hideLoading();

          if (sortMaster && typeof sortMaster === 'object' && sortMaster.sortMasterNo) {
            console.log('‚úÖ VALIDATION PASSED - Populating form');

            // ‚úÖ FIX: Disable form BEFORE populating if in view mode
            if (mode === 'view') {
              isViewMode = true; // Set global flag
              disableFormForView();
            }

            populateFormWithData(sortMaster);

            // ‚úÖ Disable again after populating to catch dynamically added rows
            if (mode === 'view') {
              disableFormForView();
            }
          } else {
            console.error('‚ùå VALIDATION FAILED');
            console.error('Condition 1 (sortMaster):', !!sortMaster);
            console.error('Condition 2 (typeof):', typeof sortMaster === 'object');
            console.error('Condition 3 (sortMasterNo):', sortMaster ? !!sortMaster.sortMasterNo : 'N/A');
            showMessage('Sort Master not found', 'error');
          }
        })
        .withFailureHandler(function (error) {
          hideLoading();
          console.error('‚ùå FAILURE HANDLER:', error);
          showMessage('Error loading Sort Master: ' + (error.message || error), 'error');
        })
        .getCompleteSortMaster(sortMasterId);
    }

    // Populate form with existing Sort Master data
    function populateFormWithData(data) {
      console.log('Populating form with:', data);

      // Basic fields
      document.getElementById('fabricType').value = data.fabricType || '';
      document.getElementById('sortMasterNo').value = data.sortMasterNo || '';
      document.getElementById('qualityDetails').value = data.qualityDetails || data.quality || '';
      document.getElementById('weaveId').value = data.weaveName || '';
      document.getElementById('createFor').value = data.isExportOrder === 1 ? 'Export' : 'Domestic';
      document.getElementById('rtweNo').value = data.rtweNo || '';
      document.getElementById('brokerName').value = data.brokerName || '';
      document.getElementById('reed').value = data.reed || '';
      document.getElementById('denting').value = data.denting || '';
      document.getElementById('multiDents').value = data.multiDents || '';
      document.getElementById('finalReed').value = data.finalReed || '';
      document.getElementById('width').value = data.width || '';
      document.getElementById('extraWidth').value = data.threadOrGala || '';
      document.getElementById('picks').value = data.totalPicks || '';
      document.getElementById('reedSpace').value = data.reedSpace || '';
      document.getElementById('totalEnds').value = data.totalEnds || '';
      document.getElementById('widthCm').value = data.widthInCms || '';
      document.getElementById('composition').value = data.composition || '';
      document.getElementById('pickInsert').value = data.pickInsert || 1;
      document.getElementById('loomType').value = data.loomTypeName || data.loomType || '';
      document.getElementById('selvedgeId').value = data.selvedgeName || '';
      document.getElementById('dentsWidth').value = data.dents || '';
      document.getElementById('sizePickup').value = data.sizePickUp || '';
      document.getElementById('endsPerDent').value = data.endsPerDents || '';
      document.getElementById('selvedgeEnds').value = data.selvedgeEnds || '';
      document.getElementById('endsWithSelvedge').value = (data.totalEnds || 0) + (data.selvedgeEnds || 0);
      document.getElementById('paperTubeSize').value = data.paperTubeSizeName || '';
      document.getElementById('beamTypeMain').value = data.beamType || '';
      document.getElementById('selvedgeDrawing').value = data.selvedgeDrawing || '';
      document.getElementById('masterQuality').value = data.masterQuality || '';
      document.getElementById('onLoom').value = data.onLoom || '';
      document.getElementById('glmNoShrink').value = data.glmWithoutWastage || '';
      document.getElementById('gsmWithShrink').value = data.gsm || '';
      document.getElementById('gsmNoShrink').value = data.gsmWithoutWastage || '';
      document.getElementById('displayQuality').value = data.displayQuality || '';
      document.getElementById('totalWarpPattern').value = data.totalWarpPattern || '';
      document.getElementById('totalWeftPattern').value = data.totalWeftPattern || '';
      document.getElementById('totalWarpGrms').value = data.totalWarpGrmsPerMtr || '';
      document.getElementById('totalWeftGrms').value = data.totalWeftGrmsPerMtr || '';
      document.getElementById('actGlm').value = data.actGlm || '';
      document.getElementById('actGsm').value = data.actGsm || '';
      document.getElementById('pegPlan').value = data.pegPlan || '';
      document.getElementById('drawing').value = data.sortDrawing || '';
      document.getElementById('remark').value = data.remark || '';
      document.getElementById('isMasterQuality').checked = data.isMasterQuality || false;
      document.getElementById('hasSelvedge').checked = data.selvedgeId ? true : false;
      document.getElementById('l2l').value = data.l2l || '';
      document.getElementById('hsnNumber').value = data.hsnCode || '';
      document.getElementById('igst').value = data.igstPercent || 0;
      document.getElementById('cgst').value = data.cgstPercent || 0;
      document.getElementById('sgst').value = data.sgstPercent || 0;
      document.getElementById('hsnDescription').value = data.hsnDescription || '';

      // Quality Sort No
      if (data.qualityDetails) {
        document.getElementById('qualitySortNo').value = data.qualityDetails.replace(/[^0-9]/g, '');
      }

      // Populate warp rows
      if (data.warpDetails && data.warpDetails.length > 0) {
        data.warpDetails.forEach(function (warpRow) {
          addWarpRowWithData(warpRow);
        });
      }

      // Populate weft rows
      if (data.weftDetails && data.weftDetails.length > 0) {
        data.weftDetails.forEach(function (weftRow) {
          addWeftRowWithData(weftRow);
        });
      }

      // If no warp/weft rows, add empty ones
      if (!data.warpDetails || data.warpDetails.length === 0) {
        addWarpRow();
      }
      if (!data.weftDetails || data.weftDetails.length === 0) {
        addWeftRow();
      }
    }

    // Add warp row with existing data
    function addWarpRowWithData(rowData) {
      warpCounter++;
      const tbody = document.getElementById('warpBody');
      const tr = document.createElement('tr');
      tr.id = 'warp' + warpCounter;

      const materialOptions = itemMasterData.map(i =>
        `<option value="${i.itemName}" data-id="${i.itemId}" data-count="${i.englishCount}">`
      ).join('');

      tr.innerHTML = `
        <td>
          <input type="text" class="warp-beam" list="warpBeamList${warpCounter}" placeholder="Select or type..." value="${rowData.beamTypeName || ''}" onchange="triggerAutoCalculate()">
          <datalist id="warpBeamList${warpCounter}">
            <option value="BOTTOM">
            <option value="TOP">
            <option value="BOBBIN">
            <option value="SELVEDGE">
          </datalist>
        </td>
        <td><input type="number" class="warp-pattern" step="0.01" value="${rowData.pattern || ''}" oninput="triggerAutoCalculate()"></td>
        <td>
          <input type="text" class="warp-material" list="warpMaterialList${warpCounter}" placeholder="Select or type..." value="${rowData.itemName || ''}" onchange="materialChanged(this, 'warp'); triggerAutoCalculate();">
          <datalist id="warpMaterialList${warpCounter}">
            ${materialOptions}
          </datalist>
        </td>
        <td><input type="number" class="warp-count" step="0.01" value="${rowData.englishCount || ''}" oninput="triggerAutoCalculate()"></td>
        <td><input type="number" class="warp-shrink" step="0.01" value="${rowData.wastePerShrink || 0}" oninput="triggerAutoCalculate()"></td>
        <td><input type="number" class="warp-ends-calc" readonly value="${rowData.ends || ''}"></td>
        <td><input type="number" class="warp-grms-calc" readonly value="${rowData.grmsPerMtr || ''}"></td>
        <td><input type="number" class="warp-grms-noshrink" readonly value="${rowData.grmsPerMtr_NoShrinkage || ''}"></td>
        <td></td>
        <td><button class="btn-remove" onclick="removeRow('warp${warpCounter}')">üóëÔ∏è</button></td>
      `;

      tbody.appendChild(tr);
    }

    // Add weft row with existing data
    function addWeftRowWithData(rowData) {
      weftCounter++;
      const tbody = document.getElementById('weftBody');
      const tr = document.createElement('tr');
      tr.id = 'weft' + weftCounter;

      const materialOptions = itemMasterData.map(i =>
        `<option value="${i.itemName}" data-id="${i.itemId}" data-count="${i.englishCount}">`
      ).join('');

      tr.innerHTML = `
        <td><input type="number" class="weft-pattern" step="0.01" value="${rowData.pattern || ''}" oninput="triggerAutoCalculate()"></td>
        <td>
          <input type="text" class="weft-material" list="weftMaterialList${weftCounter}" placeholder="Select or type..." value="${rowData.itemName || ''}" onchange="materialChanged(this, 'weft'); triggerAutoCalculate();">
          <datalist id="weftMaterialList${weftCounter}">
            ${materialOptions}
          </datalist>
        </td>
        <td><input type="number" class="weft-count" step="0.01" value="${rowData.englishCount || ''}" oninput="triggerAutoCalculate()"></td>
        <td><input type="number" class="weft-shrink" step="0.01" value="${rowData.wastePerShrink || 0}" oninput="triggerAutoCalculate()"></td>
        <td><input type="number" class="weft-picks-calc" readonly value="${rowData.picks || ''}"></td>
        <td><input type="number" class="weft-grms-calc" readonly value="${rowData.grmsPerMtr || ''}"></td>
        <td><input type="number" class="weft-grms-noshrink" readonly value="${rowData.grmsPerMtr_NoShrinkage || ''}"></td>
        <td></td>
        <td><button class="btn-remove" onclick="removeRow('weft${weftCounter}')">üóëÔ∏è</button></td>
      `;

      tbody.appendChild(tr);
    }

    // Disable form fields for view mode
    function disableFormForView() {
      const inputs = document.querySelectorAll('input, select, textarea');
      inputs.forEach(function (input) {
        input.disabled = true;
      });

      // Hide action buttons
      document.getElementById('btnSave').style.display = 'none';
      document.getElementById('btnShare').style.display = 'none';

      // Hide add/remove buttons
      const addButtons = document.querySelectorAll('.btn-add');
      addButtons.forEach(btn => btn.style.display = 'none');

      const removeButtons = document.querySelectorAll('.btn-remove');
      removeButtons.forEach(btn => btn.style.display = 'none');
    }

    // Add warp row
    function addWarpRow() {
      warpCounter++;
      const tbody = document.getElementById('warpBody');
      const tr = document.createElement('tr');
      tr.id = 'warp' + warpCounter;

      // Create datalist options for materials
      const materialOptions = itemMasterData.map(i =>
        `<option value="${i.itemName}" data-id="${i.itemId}" data-count="${i.englishCount}">`
      ).join('');

      tr.innerHTML = `
        <td>
          <input type="text" class="warp-beam" list="warpBeamList${warpCounter}" placeholder="Select or type..." onchange="triggerAutoCalculate()">
          <datalist id="warpBeamList${warpCounter}">
            <option value="BOTTOM">
            <option value="TOP">
            <option value="BOBBIN">
            <option value="SELVEDGE">
          </datalist>
        </td>
        <td><input type="number" class="warp-pattern" step="0.01" oninput="triggerAutoCalculate()"></td>
        <td>
          <input type="text" class="warp-material" list="warpMaterialList${warpCounter}" placeholder="Select or type..." onchange="materialChanged(this, 'warp'); triggerAutoCalculate();">
          <datalist id="warpMaterialList${warpCounter}">
            ${materialOptions}
          </datalist>
        </td>
        <td><input type="number" class="warp-count" step="0.01" oninput="triggerAutoCalculate()"></td>
        <td><input type="number" class="warp-shrink" step="0.01" value="0" oninput="triggerAutoCalculate()"></td>
        <td><input type="number" class="warp-ends-calc" readonly></td>
        <td><input type="number" class="warp-grms-calc" readonly></td>
        <td><input type="number" class="warp-grms-noshrink" readonly></td>
        <td></td>
        <td><button class="btn-remove" onclick="removeRow('warp${warpCounter}')">üóëÔ∏è</button></td>
      `;

      tbody.appendChild(tr);
    }

    // Add weft row
    function addWeftRow() {
      weftCounter++;
      const tbody = document.getElementById('weftBody');
      const tr = document.createElement('tr');
      tr.id = 'weft' + weftCounter;

      // Create datalist options for materials
      const materialOptions = itemMasterData.map(i =>
        `<option value="${i.itemName}" data-id="${i.itemId}" data-count="${i.englishCount}">`
      ).join('');

      tr.innerHTML = `
        <td><input type="number" class="weft-pattern" step="0.01" oninput="triggerAutoCalculate()"></td>
        <td>
          <input type="text" class="weft-material" list="weftMaterialList${weftCounter}" placeholder="Select or type..." onchange="materialChanged(this, 'weft'); triggerAutoCalculate();">
          <datalist id="weftMaterialList${weftCounter}">
            ${materialOptions}
          </datalist>
        </td>
        <td><input type="number" class="weft-count" step="0.01" oninput="triggerAutoCalculate()"></td>
        <td><input type="number" class="weft-shrink" step="0.01" value="0" oninput="triggerAutoCalculate()"></td>
        <td><input type="number" class="weft-picks-calc" readonly></td>
        <td><input type="number" class="weft-grms-calc" readonly></td>
        <td><input type="number" class="weft-grms-noshrink" readonly></td>
        <td></td>
        <td><button class="btn-remove" onclick="removeRow('weft${weftCounter}')">üóëÔ∏è</button></td>
      `;

      tbody.appendChild(tr);
    }

    // Remove row
    function removeRow(id) {
      const row = document.getElementById(id);
      if (row) row.remove();
      // Trigger recalculation after removing row
      triggerAutoCalculate();
    }

    // Material changed - auto-fill count (Updated for input+datalist combobox)
    function materialChanged(inputElement, type) {
      try {
        var row = inputElement.closest('tr');
        if (!row) {
          console.error('‚ùå Row not found');
          return;
        }

        var materialValue = inputElement.value;
        var countInput = row.querySelector('.' + type + '-count');

        if (!materialValue || materialValue === '') {
          // Empty value - clear count
          if (countInput) {
            countInput.value = '';
          }
          return;
        }

        // Find matching item in itemMasterData by name
        var matchedItem = itemMasterData.find(function (item) {
          return item.itemName === materialValue || item.itemId === materialValue;
        });

        if (matchedItem && matchedItem.englishCount) {
          // Valid match - auto-fill count
          countInput.value = parseFloat(matchedItem.englishCount);

          // Visual feedback
          countInput.classList.add('auto-filled');
          setTimeout(function () {
            countInput.classList.remove('auto-filled');
          }, 500);

          console.log('‚úì Auto-filled: ' + materialValue + ' ‚Üí Count: ' + matchedItem.englishCount);

          // Trigger calculation
          triggerAutoCalculate();

        } else {
          // No match or custom entry - user must enter count manually
          console.log('‚ÑπÔ∏è Custom material: ' + materialValue + ' - enter count manually');
          countInput.placeholder = 'Enter count';
        }

      } catch (error) {
        console.error('‚ùå Error in materialChanged:', error);
      }
    }

    // Update Quality Sort No - Extract only numbers from Quality Details
    // Example: "66RS/144*72/80DULL*40CO" ‚Üí "66144728040"
    function updateQualitySortNo() {
      const qualityDetails = document.getElementById('qualityDetails').value;
      // Extract only numeric digits
      const numbersOnly = qualityDetails.replace(/[^0-9]/g, '');
      document.getElementById('qualitySortNo').value = numbersOnly;
    }

    // Auto-calculation debounce timer
    let autoCalcTimer = null;

    // Trigger auto-calculation with debounce
    function triggerAutoCalculate() {
      // ‚úÖ FIX: Skip auto-calculations in view mode
      if (isViewMode) {
        console.log('‚è∏Ô∏è Skipping auto-calculate in view mode');
        return;
      }

      // Clear previous timer
      if (autoCalcTimer) {
        clearTimeout(autoCalcTimer);
      }

      // Set new timer - instant calculation (0ms)
      autoCalcTimer = setTimeout(function () {
        autoCalculate();
      }, 0);
    }

    // Auto-calculate (silent version without loading overlay)
    function autoCalculate() {
      // Skip if in view mode
      if (isViewMode) {
        return;
      }

      // Only calculate if we have enough data
      const warpRows = document.querySelectorAll('#warpBody tr');
      const weftRows = document.querySelectorAll('#weftBody tr');

      if (warpRows.length === 0 && weftRows.length === 0) {
        return; // No data to calculate
      }

      const formData = collectFormData();

      // Check if we have minimum required data
      if (!formData.reed || !formData.denting || !formData.width || !formData.picks) {
        console.log('‚ö†Ô∏è Missing basic data - skipping auto-calculate');
        return;
      }

      if (!formData.warpRows || formData.warpRows.length === 0) {
        console.log('‚ö†Ô∏è No warp rows - skipping auto-calculate');
        return;
      }

      if (!formData.weftRows || formData.weftRows.length === 0) {
        console.log('‚ö†Ô∏è No weft rows - skipping auto-calculate');
        return;
      }

      // ‚úÖ DEBUG: Log warp/weft data being sent
      console.log('üìä Form Data Being Sent:');
      console.log('Warp Rows:', formData.warpRows);
      console.log('Weft Rows:', formData.weftRows);
      formData.warpRows.forEach(function (row, i) {
        console.log('Warp Row ' + i + ': pattern=' + row.pattern + ', englishCount=' + row.englishCount + ', wastePerShrink=' + row.wastePerShrink);
      });
      formData.weftRows.forEach(function (row, i) {
        console.log('Weft Row ' + i + ': pattern=' + row.pattern + ', englishCount=' + row.englishCount + ', wastePerShrink=' + row.wastePerShrink);
      });

      // Call server for calculation (silent - no loading overlay)
      google.script.run
        .withSuccessHandler(function (data) {
          if (data.success) {
            displayCalculations(data.calculations);
            console.log('‚úÖ Auto-calculation complete');
            console.log('üìà Calculation Results:', data.calculations);
          } else {
            console.log('Auto-calculation failed:', data.message);
          }
        })
        .withFailureHandler(function (error) {
          console.error('Auto-calculation error:', error);
        })
        .calculateSortMaster(formData);
    }

    // Calculate all - using google.script.run
    function calculateAll() {
      if (!validateForm()) return;

      showLoading('Calculating...');

      const formData = collectFormData();

      google.script.run
        .withSuccessHandler(function (data) {
          hideLoading();

          if (data.success) {
            displayCalculations(data.calculations);
            showMessage('‚úÖ Calculations complete!', 'success');
          } else {
            showMessage('Calculation failed: ' + data.message, 'error');
          }
        })
        .withFailureHandler(function (error) {
          hideLoading();
          showMessage('Error: ' + error.message, 'error');
        })
        .calculateSortMaster(formData);
    }

    // Validate form
    function validateForm() {
      const required = ['fabricType', 'weaveId', 'createFor', 'rtweNo', 'brokerName',
        'reed', 'denting', 'width', 'picks'];

      for (let field of required) {
        const elem = document.getElementById(field);
        if (!elem.value) {
          showMessage('Please fill: ' + field, 'error');
          elem.focus();
          return false;
        }
      }

      const warpRows = document.querySelectorAll('#warpBody tr');
      if (warpRows.length === 0) {
        showMessage('Please add at least one warp row', 'error');
        return false;
      }

      const weftRows = document.querySelectorAll('#weftBody tr');
      if (weftRows.length === 0) {
        showMessage('Please add at least one weft row', 'error');
        return false;
      }

      return true;
    }

    // ‚úÖ FIX #2: Collect form data - totalPicks ADDED
    function collectFormData() {
      const weaveValue = document.getElementById('weaveId').value;
      const createForValue = document.getElementById('createFor').value;

      const data = {
        // ‚úÖ CRITICAL: sessionId must be included for backend validation
        sessionId: sessionId,
        // Include mode, sortMasterId, and user info for edit functionality
        mode: mode,
        sortMasterId: sortMasterId,
        userId: userId,
        userName: userName,

        // Basic info - matching Datasave.gs expected field names
        fabricType: document.getElementById('fabricType').value,
        sortMasterNo: document.getElementById('sortMasterNo').value,
        qualityDetails: document.getElementById('qualityDetails').value,
        weaveId: weaveValue,
        weaveName: weaveValue,
        sheddingMechanismId: weaveValue,
        createFor: createForValue,
        isExportOrder: createForValue === 'Export' ? 1 : 0,
        rtweNo: document.getElementById('rtweNo').value,
        brokerName: document.getElementById('brokerName').value,

        // Reed and width
        reed: parseFloat(document.getElementById('reed').value) || 0,
        denting: parseFloat(document.getElementById('denting').value) || 0,
        dents: document.getElementById('multiDents').value, // multiDents ‚Üí dents
        width: parseFloat(document.getElementById('width').value) || 0,
        threadOrGala: parseFloat(document.getElementById('extraWidth').value) || 0, // extraWidth ‚Üí threadOrGala

        // Picks
        picks: parseInt(document.getElementById('picks').value) || 0,
        totalPicks: parseInt(document.getElementById('picks').value) || 0,
        pickInsert: parseFloat(document.getElementById('pickInsert').value) || 1,

        // Other fields
        composition: document.getElementById('composition').value,
        loomType: document.getElementById('loomType').value,
        loomTypeName: document.getElementById('loomType').value,

        // Selvedge
        selvedgeId: document.getElementById('selvedgeId').value,
        selvedgeName: document.getElementById('selvedgeId').value, // Same as ID for now
        selvedgeWidth: parseFloat(document.getElementById('dentsWidth').value) || 0, // dentsWidth ‚Üí selvedgeWidth
        endsPerDents: parseFloat(document.getElementById('endsPerDent').value) || 0, // endsPerDent ‚Üí endsPerDents
        selvedgeEnds: parseInt(document.getElementById('selvedgeEnds').value) || 0,

        // Size, Tube, Beam
        sizePickUp: parseFloat(document.getElementById('sizePickup').value) || 0, // sizePickup ‚Üí sizePickUp
        paperTubeSizeId: document.getElementById('paperTubeSize').value,
        paperTubeSizeName: document.getElementById('paperTubeSize').value,
        beamType: document.getElementById('beamTypeMain').value,
        selvedgeDrawing: document.getElementById('selvedgeDrawing').value,

        // Master quality & drawing
        masterQuality: document.getElementById('masterQuality').value,
        onLoom: document.getElementById('onLoom').value,
        pegPlan: document.getElementById('pegPlan').value,
        sortDrawing: document.getElementById('drawing').value, // drawing ‚Üí sortDrawing
        remark: document.getElementById('remark').value,
        isMasterQuality: document.getElementById('isMasterQuality').checked,
        hasSelvedge: document.getElementById('hasSelvedge').checked,
        l2l: document.getElementById('l2l').value,

        // HSN & Tax
        hsnCode: document.getElementById('hsnNumber').value, // hsnNumber ‚Üí hsnCode
        hsnDescription: document.getElementById('hsnDescription').value,
        igstPercent: parseFloat(document.getElementById('igst').value) || 0, // igst ‚Üí igstPercent
        cgstPercent: parseFloat(document.getElementById('cgst').value) || 0, // cgst ‚Üí cgstPercent
        sgstPercent: parseFloat(document.getElementById('sgst').value) || 0, // sgst ‚Üí sgstPercent
        cessPercent: 0,

        // Actual GLM/GSM
        actGlm: parseFloat(document.getElementById('actGlm').value) || 0,
        actGsm: parseFloat(document.getElementById('actGsm').value) || 0,

        // Warp and Weft rows
        warpRows: [],
        weftRows: []
      };

      // Collect warp rows
      document.querySelectorAll('#warpBody tr').forEach(row => {
        data.warpRows.push({
          beamType: row.querySelector('.warp-beam').value,
          pattern: parseFloat(row.querySelector('.warp-pattern').value) || 0,
          itemId: row.querySelector('.warp-material').value,
          itemName: row.querySelector('.warp-material').value, // Now input, same value
          englishCount: parseFloat(row.querySelector('.warp-count').value) || 0,
          wastePerShrink: parseFloat(row.querySelector('.warp-shrink').value) || 0
        });
      });

      // Collect weft rows
      document.querySelectorAll('#weftBody tr').forEach(row => {
        data.weftRows.push({
          pattern: parseFloat(row.querySelector('.weft-pattern').value) || 0,
          itemId: row.querySelector('.weft-material').value,
          itemName: row.querySelector('.weft-material').value, // Now input, same value
          englishCount: parseFloat(row.querySelector('.weft-count').value) || 0,
          wastePerShrink: parseFloat(row.querySelector('.weft-shrink').value) || 0
        });
      });

      return data;
    }

    // Display calculations
    function displayCalculations(calc) {
      document.getElementById('finalReed').value = calc.finalReed?.toFixed(2) || '';
      document.getElementById('reedSpace').value = calc.reedSpace?.toFixed(3) || '';
      document.getElementById('totalEnds').value = calc.totalEnds || '';
      document.getElementById('widthCm').value = calc.widthInCms?.toFixed(2) || '';
      document.getElementById('glmNoShrink').value = calc.glmWithoutShrinkage?.toFixed(3) || '';
      document.getElementById('gsmWithShrink').value = calc.gsm?.toFixed(3) || '';
      document.getElementById('gsmNoShrink').value = calc.gsmWithoutShrinkage?.toFixed(3) || '';
      document.getElementById('displayQuality').value = calc.qualityString || '';
      document.getElementById('totalWarpPattern').value = calc.totalWarpPattern || '';
      document.getElementById('totalWeftPattern').value = calc.totalWeftPattern || '';
      document.getElementById('totalWarpGrms').value = calc.totalWarpGrmsPerMtr?.toFixed(3) || '';
      document.getElementById('totalWeftGrms').value = calc.totalWeftGrmsPerMtr?.toFixed(3) || '';

      // ‚úÖ FIX: Display selvedge calculations correctly
      // Backend returns: selvedgeEnds and totalEnds (which includes selvedge when applicable)
      document.getElementById('selvedgeEnds').value = calc.selvedgeEnds || '';
      document.getElementById('endsWithSelvedge').value = calc.totalEnds || '';

      // Update warp row calculations
      if (calc.warpCalculations) {
        const warpRows = document.querySelectorAll('#warpBody tr');
        warpRows.forEach((row, i) => {
          if (calc.warpCalculations[i]) {
            const c = calc.warpCalculations[i];
            row.querySelector('.warp-ends-calc').value = c.ends || '';
            row.querySelector('.warp-grms-calc').value = c.grmsWithShrinkage?.toFixed(3) || '';
            row.querySelector('.warp-grms-noshrink').value = c.grmsWithoutShrinkage?.toFixed(3) || '';
          }
        });
      }

      // Update weft row calculations
      if (calc.weftCalculations) {
        const weftRows = document.querySelectorAll('#weftBody tr');
        weftRows.forEach((row, i) => {
          if (calc.weftCalculations[i]) {
            const c = calc.weftCalculations[i];
            row.querySelector('.weft-picks-calc').value = c.picks || '';
            row.querySelector('.weft-grms-calc').value = c.grmsWithShrinkage?.toFixed(3) || '';
            row.querySelector('.weft-grms-noshrink').value = c.grmsWithoutShrinkage?.toFixed(3) || '';
          }
        });
      }
    }

    // Handle save - using google.script.run
    function handleSave(sendNotifications) {
      if (!validateForm()) return;

      if (!document.getElementById('gsmWithShrink').value) {
        if (!confirm('Please calculate first. Calculate now?')) return;
        calculateAll();
        return;
      }

      showLoading(mode === 'edit' ? 'Updating...' : 'Saving...');

      const formData = collectFormData();

      // Success handler
      const successHandler = function (data) {
        hideLoading();

        if (data.success) {
          const message = mode === 'edit'
            ? '‚úÖ Updated: ' + (data.sortMasterNo || formData.sortMasterNo)
            : '‚úÖ Saved: ' + data.sortMasterNo;
          showMessage(message, 'success');
          setTimeout(() => {
            window.location.href = webAppUrl + '?page=complete-orders&session=' + sessionId;
          }, 2000);
        } else {
          showMessage((mode === 'edit' ? 'Update' : 'Save') + ' failed: ' + data.message, 'error');
        }
      };

      // Failure handler
      const failureHandler = function (error) {
        hideLoading();
        showMessage('Error: ' + error.message, 'error');
      };

      // Call different function based on mode
      if (mode === 'edit' && sortMasterId) {
        google.script.run
          .withSuccessHandler(successHandler)
          .withFailureHandler(failureHandler)
          .updateSortMasterFromUI(sortMasterId, formData);
      } else {
        google.script.run
          .withSuccessHandler(successHandler)
          .withFailureHandler(failureHandler)
          .saveSortMasterFromUI(formData, sendNotifications);
      }
    }

    // Go back - smart redirect based on mode
    function goBack() {
      // Determine where to go back to based on mode
      const backPage = (mode === 'view' || mode === 'edit') ? 'complete-orders' : 'pending-orders';
      const backUrl = webAppUrl + '?page=' + backPage + '&session=' + sessionId;

      // If view mode, no confirmation needed (no changes to discard)
      if (mode === 'view') {
        showLoading('Going back...');
        window.location.href = backUrl;
        return;
      }

      // For create/edit mode, confirm before discarding changes
      showConfirmModal('Are you sure you want to discard all changes?', function () {
        showLoading('Going back...');
        window.location.href = backUrl;
      });
    }

    // Show confirm modal
    function showConfirmModal(message, onConfirm) {
      document.getElementById('confirmMessage').textContent = message;
      document.getElementById('confirmModal').classList.add('show');

      const confirmBtn = document.getElementById('confirmBtn');
      // Remove old listeners
      const newBtn = confirmBtn.cloneNode(true);
      confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);

      newBtn.addEventListener('click', function () {
        hideConfirmModal();
        if (onConfirm) onConfirm();
      });
    }

    // Hide confirm modal
    function hideConfirmModal() {
      document.getElementById('confirmModal').classList.remove('show');
    }


    // Show loading
    function showLoading(text) {
      document.getElementById('loadingText').textContent = text;
      document.getElementById('loadingOverlay').classList.add('show');
    }

    // Hide loading
    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('show');
    }

    // Show message
    function showMessage(text, type) {
      const msg = document.getElementById('messageArea');
      msg.innerHTML = `<div class="message ${type}">${text}</div>`;
      msg.scrollIntoView({ behavior: 'smooth' });

      if (type === 'success') {
        setTimeout(() => { msg.innerHTML = ''; }, 5000);
      }
    }
  </script>

</body>

</html>