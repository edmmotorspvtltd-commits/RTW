<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employees - RTWE ERP Attendance</title>
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="stylesheet" href="css/toast.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg-main);
            display: flex;
            min-height: 100vh;
        }

        .top-header {
            background: var(--bg-card);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .page-title {
            font-size: 22px;
            font-weight: 600;
            color: var(--primary-dark);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .content-area {
            padding: 25px 30px;
            flex: 1;
        }

        .card {
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid var(--border);
        }

        .card-header {
            padding: 18px 22px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-dark);
        }

        .card-body {
            padding: 20px 22px;
        }

        .search-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
        }

        .filter-select {
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            min-width: 150px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            font-size: 13px;
        }

        .data-table th {
            background: var(--bg-main);
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
        }

        .data-table tr {
            border-bottom: 1px solid var(--border);
        }

        .data-table tr:hover {
            background: #FAFAFA;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-badge.active {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .status-badge.inactive {
            background: #FFEBEE;
            color: #C62828;
        }

        .action-btns {
            display: flex;
            gap: 8px;
        }

        .action-btns button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-edit {
            background: #E3F2FD;
            color: #1565C0;
        }

        .btn-delete {
            background: #FFEBEE;
            color: #C62828;
        }

        .btn-sync {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .btn-sync:hover {
            background: #C8E6C9;
        }

        .employee-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .employee-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .employee-details strong {
            display: block;
            color: var(--text-primary);
        }

        .employee-details small {
            color: var(--text-secondary);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-dark);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state .icon {
            font-size: 64px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .bulk-actions {
            background: linear-gradient(135deg, #5D4037, #3d2314);
            padding: 12px 20px;
            border-radius: 8px;
            display: none;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            color: white;
            animation: slideDown 0.3s ease;
        }

        .bulk-actions.show {
            display: flex;
        }

        .bulk-actions-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .bulk-actions .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            font-size: 13px;
        }

        .bulk-actions .btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .bulk-actions .btn-delete-bulk {
            background: #f44336;
            border: none;
        }

        .bulk-actions .btn-delete-bulk:hover {
            background: #d32f2f;
        }

        .checkbox-cell {
            width: 40px;
            text-align: center;
        }

        .checkbox-cell input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .bulk-actions {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>

<body>
    <div id="sidebarContainer"></div>
    <main class="main-content">
        <header class="top-header">
            <div style="display: flex; align-items: center; gap: 15px;">
                <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>
                <h1 class="page-title">üë• Employees</h1>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn" style="background:#E8EAF6;color:#3F51B5" onclick="downloadTemplate()">üì• Download
                    Template</button>
                <button class="btn" style="background:#FFF3E0;color:#E65100" onclick="openImportModal()">üì§ Import from
                    Excel</button>
                <button class="btn" style="background:#FFF3E0;color:#E65100" onclick="viewDeviceUsers()">üëÅÔ∏è View Device
                    Users</button>
                <button class="btn" style="background:#E1F5FE;color:#0277BD" onclick="syncAttendanceFromDevice()">üîÑ
                    Sync Attendance</button>
                <button class="btn" style="background:#E8F5E9;color:#2E7D32" onclick="syncAllToDevice()">üì± Sync All to
                    Device</button>
                <button class="btn btn-primary" onclick="openAddModal()">+ Add Employee</button>
            </div>
        </header>
        <div class="content-area">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Employee List</h2><span id="employeeCount">0 employees</span>
                </div>
                <div class="card-body">
                    <div class="search-filter">
                        <input type="text" class="search-box" id="searchInput"
                            placeholder="Search by name, code, email..." oninput="filterEmployees()">
                        <select class="filter-select" id="departmentFilter" onchange="filterEmployees()">
                            <option value="">All Departments</option>
                        </select>
                        <select class="filter-select" id="statusFilter" onchange="filterEmployees()">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div id="bulkActionsBar" class="bulk-actions">
                        <div class="bulk-actions-left">
                            <span id="selectionCount">0 selected</span>
                        </div>
                        <div>
                            <button class="btn" onclick="clearSelection()">Clear Selection</button>
                            <button class="btn btn-delete-bulk" onclick="deleteSelectedEmployees()">üóë Delete
                                Selected</button>
                        </div>
                    </div>
                    <div id="employeeTableContainer">
                        <div class="loading">
                            <div class="spinner"></div>Loading...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modern Confirm Modal -->
    <div class="modal-overlay" id="confirmModal" style="z-index:1100;">
        <div class="modal" style="max-width:400px;text-align:center;">
            <div style="font-size:48px;margin-bottom:15px;" id="confirmIcon">üì±</div>
            <h2 style="margin:0 0 10px;font-size:20px;" id="confirmTitle">Sync to Device</h2>
            <p style="color:#666;margin:0 0 25px;font-size:14px;" id="confirmMessage">Are you sure?</p>
            <div style="display:flex;gap:10px;justify-content:center;">
                <button onclick="closeConfirmModal(false)"
                    style="padding:12px 30px;border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer;font-size:14px;">Cancel</button>
                <button onclick="closeConfirmModal(true)"
                    style="padding:12px 30px;border:none;background:linear-gradient(135deg,#4a90d9,#357abd);color:#fff;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Device Users Modal -->
    <div class="modal-overlay" id="deviceUsersModal">
        <div class="modal" style="max-width:700px;">
            <div class="modal-header">
                <h2 class="modal-title">üëÅÔ∏è Users on ESSL Device</h2>
                <button class="modal-close" onclick="closeDeviceUsersModal()">&times;</button>
            </div>
            <div class="modal-body" style="max-height:400px;overflow-y:auto;">
                <div id="deviceUsersContent">
                    <div class="loading">
                        <div class="spinner"></div>Loading users from device...
                    </div>
                </div>
            </div>
            <div class="modal-footer"
                style="padding:15px 20px;border-top:1px solid #eee;display:flex;justify-content:space-between;align-items:center;">
                <span id="deviceUserCount" style="color:#666;font-size:14px;">0 users</span>
                <button onclick="closeDeviceUsersModal()" class="btn btn-primary">Close</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="employeeModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Add New Employee</h3><button class="modal-close"
                    onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="employeeForm">
                    <input type="hidden" id="employeeId">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Device User ID</label>
                            <div id="userIdDisplay"
                                style="padding:10px 12px;background:#f5f5f5;border:1px solid #ddd;border-radius:6px;color:#666;font-size:14px;">
                                üîÑ Auto-generated (RTWDI-001)</div>
                            <input type="hidden" id="userId">
                        </div>
                        <div class="form-group">
                            <label>Employee Code</label>
                            <div id="employeeCodeDisplay"
                                style="padding:10px 12px;background:#f5f5f5;border:1px solid #ddd;border-radius:6px;color:#666;font-size:14px;">
                                üîÑ Auto-generated</div>
                            <input type="hidden" id="employeeCode">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>First Name *</label><input type="text" id="firstName" required>
                        </div>
                        <div class="form-group"><label>Last Name</label><input type="text" id="lastName"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Email</label><input type="email" id="email"></div>
                        <div class="form-group"><label>Phone</label><input type="tel" id="phone"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Department</label><select id="departmentId">
                                <option value="">Select Department</option>
                            </select></div>
                        <div class="form-group"><label>Designation</label><input type="text" id="designation"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Hire Date</label><input type="date" id="hireDate"></div>
                        <div class="form-group"><label>Card Number</label><input type="text" id="cardNumber"
                                placeholder="RFID Card Number"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Status</label>
                            <select id="employeeStatus">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="form-group"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn" style="background:#eee"
                    onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveEmployee()">Save
                    Employee</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="importModal">
        <div class="modal" style="max-width:600px;">
            <div class="modal-header">
                <h3 class="modal-title">üì§ Import Employees from Excel</h3>
                <button class="modal-close" onclick="closeImportModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div style="background:#E3F2FD;padding:15px;border-radius:8px;margin-bottom:20px;">
                    <h4 style="margin:0 0 10px;color:#1976D2;">üìã Instructions:</h4>
                    <ol style="margin:0;padding-left:20px;color:#666;font-size:14px;">
                        <li>Click "Download Template" to get the Excel file</li>
                        <li>Fill in employee details (First Name and Status are required)</li>
                        <li>Employee Code & User ID will be auto-generated</li>
                        <li>Save the file and upload it here</li>
                    </ol>
                </div>
                <div class="form-group">
                    <label>Select Excel File (.xlsx)</label>
                    <input type="file" id="excelFile" accept=".xlsx,.xls"
                        style="padding:10px;border:2px dashed #ddd;border-radius:8px;width:100%;" />
                </div>
                <div id="importProgress" style="display:none;text-align:center;padding:20px;">
                    <div class="spinner"></div>
                    <p id="importStatus">Processing...</p>
                </div>
                <div id="importResults" style="display:none;margin-top:15px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn" style="background:#eee" onclick="closeImportModal()">Cancel</button>
                <button class="btn btn-primary" onclick="uploadExcel()">üì§ Upload & Import</button>
            </div>
        </div>
    </div>

    <script src="js/sidebar.js"></script>
    <script src="js/toast.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () { initSidebar(); });
        const API_BASE = '/api/attendance';
        let employees = [], departments = [];

        async function loadEmployees() {
            const c = document.getElementById('employeeTableContainer');
            c.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';
            try {
                const r = await fetch(`${API_BASE}/employees`, { credentials: 'include' });
                const d = await r.json();
                if (d.success) { employees = d.data; renderEmployees(employees); }
            } catch (e) { c.innerHTML = '<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><p>Error loading employees</p></div>'; }
        }

        async function loadDepartments() {
            try {
                const r = await fetch(`${API_BASE}/departments`, { credentials: 'include' });
                const d = await r.json();
                if (d.success) {
                    departments = d.data;
                    const opts = '<option value="">Select Department</option>' + departments.map(x => `<option value="${x.department_id}">${x.department_name}</option>`).join('');
                    document.getElementById('departmentId').innerHTML = opts;
                    document.getElementById('departmentFilter').innerHTML = '<option value="">All Departments</option>' + departments.map(x => `<option value="${x.department_id}">${x.department_name}</option>`).join('');
                }
            } catch (e) { console.error(e); }
        }

        function renderEmployees(data) {
            const c = document.getElementById('employeeTableContainer');
            document.getElementById('employeeCount').textContent = data.length + ' employees';
            if (!data.length) { c.innerHTML = '<div class="empty-state"><div class="icon">üë•</div><p>No employees found</p></div>'; return; }
            c.innerHTML = `<table class="data-table"><thead><tr><th class="checkbox-cell"><input type="checkbox" id="selectAll" onchange="toggleSelectAll(this.checked)"></th><th>Employee</th><th>Code</th><th>Department</th><th>Device Status</th><th>Phone</th><th>Status</th><th>Actions</th></tr></thead><tbody>${data.map(e => {
                const initials = ((e.first_name || 'U')[0] + (e.last_name || '')[0]).toUpperCase();
                const punchCount = parseInt(e.punch_count) || 0;
                let deviceStatus = '<span style="color:#C62828;">üî¥ Not Synced</span>';
                if (punchCount > 0) {
                    deviceStatus = '<span style="color:#2E7D32;">üü¢ Enrolled (' + punchCount + ')</span>';
                } else if (e.user_id && e.user_id.startsWith('RTWDI-')) {
                    deviceStatus = '<span style="color:#F57C00;">üü° Synced</span>';
                }
                return `<tr><td class="checkbox-cell"><input type="checkbox" class="employee-checkbox" data-id="${e.employee_id}" onchange="updateBulkActions()"></td><td><div class="employee-info"><div class="employee-avatar">${initials}</div><div class="employee-details"><strong>${e.full_name || e.first_name}</strong><small>${e.email || '-'}</small></div></div></td><td>${e.employee_code || e.user_id}</td><td>${e.department_name || '-'}</td><td>${deviceStatus}</td><td>${e.phone || '-'}</td><td><span class="status-badge ${e.status || 'active'}">${(e.status || 'ACTIVE').toUpperCase()}</span></td><td><div class="action-btns"><button class="btn-sync" onclick="syncToDevice(${e.employee_id})" title="Sync to Device">üì±</button><button class="btn-edit" onclick="editEmployee(${e.employee_id})">Edit</button><button class="btn-delete" onclick="deleteEmployee(${e.employee_id})">Delete</button></div></td></tr>`;
            }).join('')}</tbody></table>`;
        }

        function filterEmployees() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const dept = document.getElementById('departmentFilter').value;
            const status = document.getElementById('statusFilter').value;
            const filtered = employees.filter(e => {
                const matchSearch = !search || (e.full_name || '').toLowerCase().includes(search) || (e.employee_code || '').toLowerCase().includes(search) || (e.email || '').toLowerCase().includes(search);
                const matchDept = !dept || e.department_id == dept;
                const matchStatus = !status || e.status === status;
                return matchSearch && matchDept && matchStatus;
            });
            renderEmployees(filtered);
        }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Add New Employee';
            document.getElementById('employeeForm').reset();
            document.getElementById('employeeId').value = '';
            document.getElementById('userIdDisplay').textContent = 'üîÑ Auto-generated (RTWDI-XXX)';
            document.getElementById('employeeCodeDisplay').textContent = 'üîÑ Auto-generated';
            document.getElementById('employeeStatus').value = 'active';
            document.getElementById('employeeModal').classList.add('show');
        }
        function editEmployee(id) {
            const e = employees.find(x => x.employee_id === id); if (!e) return;
            document.getElementById('modalTitle').textContent = 'Edit Employee';
            document.getElementById('employeeId').value = id;
            document.getElementById('userId').value = e.user_id || '';
            document.getElementById('employeeCode').value = e.employee_code || '';
            document.getElementById('userIdDisplay').textContent = e.user_id || 'üîÑ Auto-generated';
            document.getElementById('employeeCodeDisplay').textContent = e.employee_code || 'üîÑ Auto-generated';
            document.getElementById('firstName').value = e.first_name || '';
            document.getElementById('lastName').value = e.last_name || '';
            document.getElementById('email').value = e.email || '';
            document.getElementById('phone').value = e.phone || '';
            document.getElementById('departmentId').value = e.department_id || '';
            document.getElementById('designation').value = e.designation || '';
            document.getElementById('cardNumber').value = e.card_number || '';
            document.getElementById('hireDate').value = e.hire_date ? e.hire_date.split('T')[0] : '';
            document.getElementById('employeeStatus').value = e.status || 'active';
            document.getElementById('employeeModal').classList.add('show');
        }
        function closeModal() { document.getElementById('employeeModal').classList.remove('show'); }

        async function saveEmployee() {
            const id = document.getElementById('employeeId').value;
            const data = { user_id: document.getElementById('userId').value, employee_code: document.getElementById('employeeCode').value, first_name: document.getElementById('firstName').value, last_name: document.getElementById('lastName').value, email: document.getElementById('email').value, phone: document.getElementById('phone').value, department_id: document.getElementById('departmentId').value || null, designation: document.getElementById('designation').value, card_number: document.getElementById('cardNumber').value, hire_date: document.getElementById('hireDate').value || null, status: document.getElementById('employeeStatus').value };
            try {
                const url = id ? `${API_BASE}/employees/${id}` : `${API_BASE}/employees`;
                const r = await fetch(url, { method: id ? 'PUT' : 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                const d = await r.json();
                if (d.success) { showToast(id ? 'Employee updated' : 'Employee added', 'success'); closeModal(); loadEmployees(); } else showToast(d.error || 'Error', 'error');
            } catch (e) { showToast('Error saving', 'error'); }
        }

        async function deleteEmployee(id) {
            const emp = employees.find(e => e.employee_id === id);
            const confirmed = await showConfirm('üóëÔ∏è', 'Delete Employee', `Delete "${emp?.full_name || 'this employee'}" permanently?`);
            if (!confirmed) return;

            try {
                const r = await fetch(`${API_BASE}/employees/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                const d = await r.json();
                if (d.success) {
                    showToast('Employee deleted successfully', 'success');
                    loadEmployees();
                } else {
                    showToast(d.error || 'Delete failed', 'error');
                }
            } catch (e) {
                showToast('Error deleting employee', 'error');
            }
        }

        // Modern confirm modal
        let confirmCallback = null;
        function showConfirm(icon, title, message) {
            return new Promise(resolve => {
                confirmCallback = resolve;
                document.getElementById('confirmIcon').textContent = icon;
                document.getElementById('confirmTitle').textContent = title;
                document.getElementById('confirmMessage').textContent = message;
                document.getElementById('confirmModal').classList.add('show');
            });
        }
        function closeConfirmModal(result) {
            document.getElementById('confirmModal').classList.remove('show');
            if (confirmCallback) confirmCallback(result);
        }

        // Sync single employee to device
        async function syncToDevice(employeeId) {
            const emp = employees.find(e => e.employee_id === employeeId);
            if (!emp) return;

            const confirmed = await showConfirm('üì±', 'Sync to Device',
                `Push "${emp.full_name || emp.first_name}" to ESSL device for biometric enrollment?`);
            if (!confirmed) return;

            showToast(`Syncing ${emp.full_name || emp.first_name} to device...`, 'info');

            try {
                const r = await fetch(`${API_BASE}/employees/${employeeId}/sync-to-device`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const d = await r.json();

                if (d.success) {
                    showToast(`‚úì ${emp.full_name || emp.first_name} synced to device!`, 'success');
                } else {
                    showToast(d.error || 'Sync failed', 'error');
                }
            } catch (e) {
                showToast('Error connecting to device: ' + e.message, 'error');
            }
        }

        // Sync all employees to device
        async function syncAllToDevice() {
            const confirmed = await showConfirm('üì±', 'Sync All Employees',
                `Push all ${employees.length} employees to ESSL device?`);
            if (!confirmed) return;

            showToast('Syncing all employees to device...', 'info');

            try {
                const devRes = await fetch(`${API_BASE}/devices`, { credentials: 'include' });
                const devData = await devRes.json();

                if (!devData.success || !devData.data.length) {
                    showToast('No devices configured', 'error');
                    return;
                }

                const device = devData.data.find(d => d.status === 'active') || devData.data[0];

                const r = await fetch(`${API_BASE}/devices/${device.device_id}/sync-users`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const d = await r.json();

                if (d.success) {
                    showToast(`‚úì ${d.synced} employees synced, ${d.failed} failed`, 'success');
                } else {
                    showToast(d.error || 'Sync failed', 'error');
                }
            } catch (e) {
                showToast('Error connecting to device: ' + e.message, 'error');
            }
        }

        // View users registered on device
        async function viewDeviceUsers() {
            document.getElementById('deviceUsersModal').classList.add('show');
            document.getElementById('deviceUsersContent').innerHTML = '<div class="loading"><div class="spinner"></div>Loading users from device...</div>';

            try {
                // Get first active device
                const devRes = await fetch(`${API_BASE}/devices`, { credentials: 'include' });
                const devData = await devRes.json();

                if (!devData.success || !devData.data.length) {
                    document.getElementById('deviceUsersContent').innerHTML = '<div class="empty-state"><p>No devices configured</p></div>';
                    return;
                }

                const device = devData.data.find(d => d.status === 'active') || devData.data[0];

                const r = await fetch(`${API_BASE}/devices/${device.device_id}/users`, { credentials: 'include' });
                const d = await r.json();

                if (d.success && d.data && d.data.length > 0) {
                    document.getElementById('deviceUserCount').textContent = `${d.data.length} users on device`;
                    document.getElementById('deviceUsersContent').innerHTML = `
                        <table class="data-table">
                            <thead><tr><th>User ID</th><th>Name</th><th>Role</th><th style="width:100px">Status</th></tr></thead>
                            <tbody>
                                ${d.data.map(u => `
                                    <tr>
                                        <td><strong>${u.userId}</strong></td>
                                        <td>${u.name || '-'}</td>
                                        <td>${u.role === 14 ? 'Admin' : 'User'}</td>
                                        <td><span class="status-badge active">Registered</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    document.getElementById('deviceUsersContent').innerHTML = '<div class="empty-state"><div class="icon">üì±</div><p>No users registered on device</p></div>';
                    document.getElementById('deviceUserCount').textContent = '0 users';
                }
            } catch (e) {
                document.getElementById('deviceUsersContent').innerHTML = `<div class="empty-state"><div class="icon">‚ùå</div><p>Error: ${e.message}</p></div>`;
            }
        }

        function closeDeviceUsersModal() {
            document.getElementById('deviceUsersModal').classList.remove('show');
        }

        // Sync attendance FROM device (fetch punches)
        async function syncAttendanceFromDevice() {
            const confirmed = await showConfirm('üîÑ', 'Sync Attendance',
                'Fetch all attendance records from ESSL device and import new punches?');
            if (!confirmed) return;

            showToast('Fetching attendance from device...', 'info');

            try {
                const devRes = await fetch(`${API_BASE}/devices`, { credentials: 'include' });
                const devData = await devRes.json();

                if (!devData.success || !devData.data.length) {
                    showToast('No devices configured', 'error');
                    return;
                }

                const device = devData.data.find(d => d.status === 'active') || devData.data[0];

                const r = await fetch(`${API_BASE}/devices/${device.device_id}/sync-attendance`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });
                const d = await r.json();

                if (d.success) {
                    showToast(`‚úì Imported ${d.imported} punches, ${d.skipped} skipped`, 'success');
                    loadEmployees();
                } else {
                    showToast(d.error || 'Sync failed', 'error');
                }
            } catch (e) {
                showToast('Error connecting to device: ' + e.message, 'error');
            }
        }

        function toggleSelectAll(checked) {
            document.querySelectorAll('.employee-checkbox').forEach(cb => cb.checked = checked);
            updateBulkActions();
        }

        function updateBulkActions() {
            const selected = document.querySelectorAll('.employee-checkbox:checked');
            const count = selected.length;
            const bulkActionsBar = document.getElementById('bulkActionsBar');
            const selectAllCheckbox = document.getElementById('selectAll');
            if (count > 0) {
                bulkActionsBar.classList.add('show');
                document.getElementById('selectionCount').textContent = `${count} employee${count > 1 ? 's' : ''} selected`;
            } else {
                bulkActionsBar.classList.remove('show');
            }
            const total = document.querySelectorAll('.employee-checkbox').length;
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = count === total && total > 0;
                selectAllCheckbox.indeterminate = count > 0 && count < total;
            }
        }

        function clearSelection() {
            document.querySelectorAll('.employee-checkbox').forEach(cb => cb.checked = false);
            const selectAll = document.getElementById('selectAll');
            if (selectAll) selectAll.checked = false;
            updateBulkActions();
        }

        function getSelectedIds() {
            return Array.from(document.querySelectorAll('.employee-checkbox:checked')).map(cb => parseInt(cb.dataset.id));
        }

        async function deleteSelectedEmployees() {
            const selectedIds = getSelectedIds();
            if (selectedIds.length === 0) return;
            const selectedEmployees = selectedIds.map(id => {
                const emp = employees.find(e => e.employee_id === id);
                return emp ? emp.full_name || emp.first_name : 'Unknown';
            });
            const confirmed = await showConfirm('üóëÔ∏è', 'Delete Multiple Employees', `Delete ${selectedIds.length} employee${selectedIds.length > 1 ? 's' : ''}?\n\n${selectedEmployees.slice(0, 5).join(', ')}${selectedIds.length > 5 ? '...' : ''}`);
            if (!confirmed) return;
            showToast(`Deleting ${selectedIds.length} employees...`, 'info');
            let successCount = 0;
            let failCount = 0;
            for (const id of selectedIds) {
                try {
                    const r = await fetch(`${API_BASE}/employees/${id}`, { method: 'DELETE', credentials: 'include' });
                    const d = await r.json();
                    if (d.success) successCount++; else failCount++;
                } catch (e) { failCount++; }
            }
            if (successCount > 0) {
                showToast(`‚úì Deleted ${successCount} employee${successCount > 1 ? 's' : ''}${failCount > 0 ? `, ${failCount} failed` : ''}`, successCount === selectedIds.length ? 'success' : 'warning');
            } else {
                showToast('Failed to delete employees', 'error');
            }
            clearSelection();
            loadEmployees();
        }

        async function downloadTemplate() {
            try {
                showToast('Downloading template...', 'info');
                const response = await fetch(`${API_BASE}/employees/template`, { credentials: 'include' });
                if (!response.ok) throw new Error('Failed to download template');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Employee_Import_Template_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                showToast('‚úì Template downloaded successfully', 'success');
            } catch (error) {
                console.error('Error downloading template:', error);
                showToast('Error downloading template', 'error');
            }
        }

        function openImportModal() {
            document.getElementById('importModal').classList.add('show');
            document.getElementById('excelFile').value = '';
            document.getElementById('importProgress').style.display = 'none';
            document.getElementById('importResults').style.display = 'none';
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('show');
        }

        async function uploadExcel() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            if (!file) { showToast('Please select an Excel file', 'warning'); return; }
            const formData = new FormData();
            formData.append('file', file);
            document.getElementById('importProgress').style.display = 'block';
            document.getElementById('importResults').style.display = 'none';
            document.getElementById('importStatus').textContent = 'Uploading and processing...';
            try {
                const response = await fetch(`${API_BASE}/employees/import`, { method: 'POST', credentials: 'include', body: formData });
                const result = await response.json();
                document.getElementById('importProgress').style.display = 'none';
                if (result.success) { showImportResults(result); loadEmployees(); }
                else { showToast(result.error || 'Import failed', 'error'); }
            } catch (error) {
                console.error('Error uploading file:', error);
                document.getElementById('importProgress').style.display = 'none';
                showToast('Error uploading file', 'error');
            }
        }

        function showImportResults(result) {
            const resultsDiv = document.getElementById('importResults');
            resultsDiv.style.display = 'block';
            let html = `<div style="background:#E8F5E9;padding:15px;border-radius:8px;border-left:4px solid #4CAF50;"><p style="margin:0;font-weight:600;color:#2E7D32;">‚úì Successfully imported: ${result.imported} employees</p></div>`;
            if (result.failed > 0) {
                html += `<div style="background:#FFEBEE;padding:15px;border-radius:8px;border-left:4px solid #f44336;margin-top:10px;"><p style="margin:0 0 10px;font-weight:600;color:#C62828;">‚úó Failed: ${result.failed} rows</p><div style="max-height:150px;overflow-y:auto;"><ul style="margin:0;padding-left:20px;font-size:13px;color:#666;">`;
                result.errors.forEach(err => { html += `<li>Row ${err.row}: ${err.error}</li>`; });
                html += `</ul></div></div>`;
            }
            resultsDiv.innerHTML = html;
            showToast(`Import complete: ${result.imported} added${result.failed > 0 ? `, ${result.failed} failed` : ''}`, result.failed === 0 ? 'success' : 'warning');
            if (result.failed === 0) setTimeout(() => closeImportModal(), 3000);
        }

        loadDepartments(); loadEmployees();
    </script>
</body>

</html>