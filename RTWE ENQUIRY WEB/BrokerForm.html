<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #2c2c2c 0%, #1a1a1a 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      background: white;
      max-width: 900px;
      width: 100%;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      overflow: hidden;
      border: 3px solid #d4a574;
    }

    .header {
      background: linear-gradient(135deg, #8b7355 0%, #6b5745 100%);
      padding: 30px;
      text-align: center;
      color: white;
    }

    .header h1 {
      font-size: 26px;
      margin-bottom: 8px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .header p {
      font-size: 14px;
      opacity: 0.95;
      font-weight: 500;
    }

    .company-section {
      background: #fff8f0;
      padding: 25px 30px;
      border-bottom: 3px solid #d4a574;
    }

    .company-section h2 {
      color: #8b7355;
      font-size: 20px;
      margin-bottom: 12px;
      font-weight: 700;
    }

    .company-section .address {
      color: #5a4a3a;
      font-size: 13px;
      line-height: 1.8;
      margin-bottom: 8px;
    }

    .company-section .contact {
      color: #8b7355;
      font-size: 14px;
      font-weight: 600;
      margin-top: 12px;
    }

    .order-details {
      padding: 25px 30px;
      background: white;
      border-bottom: 2px solid #e0e0e0;
    }

    .order-details h3 {
      color: #2c2c2c;
      font-size: 18px;
      margin-bottom: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .detail-item {
      background: #fafafa;
      padding: 14px;
      border-radius: 10px;
      border: 1px solid #e0e0e0;
    }

    .detail-item.full-width {
      grid-column: 1 / -1;
    }

    .detail-label {
      font-weight: 700;
      color: #666;
      font-size: 11px;
      text-transform: uppercase;
      margin-bottom: 6px;
      letter-spacing: 0.5px;
    }

    .detail-value {
      color: #1a1a1a;
      font-size: 15px;
      font-weight: 600;
    }

    .design-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .design-table th,
    .design-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }

    .design-table th {
      background: #f5f5f5;
      font-size: 12px;
      font-weight: 700;
      color: #666;
      text-transform: uppercase;
    }

    .design-table td {
      font-size: 14px;
      color: #333;
    }

    .form-section {
      padding: 30px;
      background: #f9f9f9;
    }

    .form-section h3 {
      color: #8b7355;
      font-size: 18px;
      margin-bottom: 22px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .message {
      display: none;
      padding: 14px 18px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 14px;
      font-weight: 600;
    }

    .message.active {
      display: block;
    }

    .message.success {
      background: #d4edda;
      border: 2px solid #c3e6cb;
      color: #155724;
    }

    .message.error {
      background: #f8d7da;
      border: 2px solid #f5c6cb;
      color: #721c24;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 25px;
      background: #fff8f0;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .loading.active {
      display: block;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #8b7355;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .loading p {
      color: #8b7355;
      font-weight: 700;
      font-size: 15px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 0;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    label {
      display: block;
      font-weight: 700;
      margin-bottom: 10px;
      color: #2c2c2c;
      font-size: 13px;
    }

    label .required {
      color: #e53935;
      font-size: 16px;
    }

    input[type="text"],
    input[type="number"],
    textarea {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 15px;
      font-family: inherit;
      transition: all 0.3s;
      background: white;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    textarea:focus {
      outline: none;
      border-color: #8b7355;
      box-shadow: 0 0 0 4px rgba(139, 115, 85, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
      line-height: 1.6;
    }

    .submit-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #8b7355 0%, #6b5745 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(139, 115, 85, 0.3);
      letter-spacing: 0.3px;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(139, 115, 85, 0.4);
      background: linear-gradient(135deg, #6b5745 0%, #5a4a3a 100%);
    }

    .submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .footer {
      background: #fafafa;
      padding: 18px;
      text-align: center;
      border-top: 2px solid #e0e0e0;
    }

    .footer p {
      font-size: 13px;
      color: #666;
      margin-bottom: 8px;
    }

    .security-badges {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .security-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #8b7355;
      font-weight: 700;
      background: white;
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid #d4a574;
    }

    @media (max-width: 768px) {

      .detail-grid,
      .form-grid {
        grid-template-columns: 1fr;
      }

      .container {
        margin: 10px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üìã Selvedge Details Submission</h1>
      <p>Secure Broker Form</p>
    </div>

    <div class="company-section">
      <h2>RAMRATAN TECHNO WEAVE</h2>
      <div class="address">
        Gat No. 234, Ward No. 24, H. No. 1770/4<br>
        Near Sonam Car Gas, Soalge Mala, Shahapur<br>
        Ichalkaranji ‚Äì 416115, Dist. Kolhapur, Maharashtra
      </div>
      <div class="contact">
        üìû 9423858123 ‚Ä¢ üåê www.ramratantextiles.com
      </div>
    </div>

    <div class="order-details">
      <h3>üì¶ Order Details</h3>
      <div class="detail-grid">
        <div class="detail-item">
          <div class="detail-label">RTWE Number</div>
          <div class="detail-value" id="rtweNo">
            <?= rtweNo ?>
          </div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Broker Name</div>
          <div class="detail-value" id="broker">Loading...</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Quality</div>
          <div class="detail-value" id="quality">Loading...</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Final Rate</div>
          <div class="detail-value" id="finalRate">Loading...</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Total MTR</div>
          <div class="detail-value" id="totalMTR">Loading...</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Total Order Value</div>
          <div class="detail-value" id="totalOrderValue">Loading...</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Delivery Date</div>
          <div class="detail-value" id="deliveryDate">Loading...</div>
        </div>
      </div>

      <div class="detail-item full-width">
        <div class="detail-label">Design & Taga Details</div>
        <table class="design-table" id="designTable">
          <thead>
            <tr>
              <th>Design</th>
              <th>Taga</th>
            </tr>
          </thead>
          <tbody id="designTableBody">
            <tr>
              <td colspan="2">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="form-section">
      <h3>üßµ Submit Selvedge Information</h3>

      <div id="message" class="message"></div>
      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Submitting details...</p>
      </div>

      <form id="brokerForm" onsubmit="submitForm(event)">
        <input type="hidden" id="token" value="<?= token ?>">

        <div class="form-grid">
          <div class="form-group">
            <label>
              Name of Selvedge <span class="required">*</span>
            </label>
            <input type="text" id="selvedgeName" placeholder="Enter selvedge name" required autocomplete="off">
          </div>

          <div class="form-group">
            <label>
              Ends of Selvedge <span class="required">*</span>
            </label>
            <input type="number" id="selvedgeEnds" placeholder="Enter ends" required autocomplete="off">
          </div>

          <div class="form-group">
            <label>
              Color of Selvedge <span class="required">*</span>
            </label>
            <input type="text" id="selvedgeColor" placeholder="Enter color" required autocomplete="off">
          </div>

          <div class="form-group full-width">
            <label>
              Remark <span style="color: #999; font-weight: normal;">(Optional)</span>
            </label>
            <textarea id="remark" placeholder="Enter any additional notes..."></textarea>
          </div>
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">
          ‚úÖ Submit Selvedge Details
        </button>
      </form>
    </div>

    <div class="footer">
      <p>Ramratan Techno Weave ‚Ä¢ RTWE System v3.0</p>
      <div class="security-badges">
        <div class="security-badge">
          <span>üîí</span>
          <span>Secure Submission</span>
        </div>
        <div class="security-badge">
          <span>‚è∞</span>
          <span>Valid 72 Hours</span>
        </div>
        <div class="security-badge">
          <span>üìù</span>
          <span>Max 3 Submissions</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    const token = '<?= token ?>';

    // Load order details on page load
    window.onload = function () {
      loadOrderDetails();
      document.getElementById('selvedgeName').focus();
    };

    function loadOrderDetails() {
      google.script.run
        .withSuccessHandler(function (data) {
          if (data) {
            document.getElementById('broker').textContent = data.broker || 'N/A';
            document.getElementById('quality').textContent = data.quality || 'N/A';
            document.getElementById('finalRate').textContent = data.finalRate ? '‚Çπ' + data.finalRate : 'N/A';
            document.getElementById('totalMTR').textContent = data.totalMTR || 'N/A';
            document.getElementById('totalOrderValue').textContent = data.totalOrderValue ? '‚Çπ' + data.totalOrderValue : 'N/A';
            document.getElementById('deliveryDate').textContent = data.deliveryDate || 'N/A';

            // Populate design table
            const tbody = document.getElementById('designTableBody');
            tbody.innerHTML = '';

            for (let i = 1; i <= 6; i++) {
              const design = data['design' + i];
              const taga = data['taga' + i];
              if (design || taga) {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = design || '-';
                row.insertCell(1).textContent = taga || '-';
              }
            }

            if (tbody.rows.length === 0) {
              tbody.innerHTML = '<tr><td colspan="2" style="text-align:center; color:#999;">No design data</td></tr>';
            }
          } else {
            showMessage('error', '‚ö†Ô∏è Could not load order details');
          }
        })
        .withFailureHandler(function (error) {
          showMessage('error', '‚ùå Error loading details: ' + error.message);
        })
        .getOrderForBroker('<?= rtweNo ?>');
    }

    function submitForm(event) {
      event.preventDefault();

      const selvedgeName = document.getElementById('selvedgeName').value.trim();
      const selvedgeEnds = document.getElementById('selvedgeEnds').value.trim();
      const selvedgeColor = document.getElementById('selvedgeColor').value.trim();
      const remark = document.getElementById('remark').value.trim();

      // Validation
      if (!selvedgeName || !selvedgeEnds || !selvedgeColor) {
        showMessage('error', '‚ö†Ô∏è Please fill all required fields');
        return;
      }

      const brokerData = {
        selvedgeName: selvedgeName,
        selvedgeEnds: selvedgeEnds,
        selvedgeColor: selvedgeColor,
        remark: remark,
        submittedAt: new Date().toISOString(),
        token: token
      };

      // Show loading state
      const msg = document.getElementById('message');
      const loading = document.getElementById('loading');
      const submitBtn = document.getElementById('submitBtn');
      const form = document.getElementById('brokerForm');

      msg.classList.remove('active');
      loading.classList.add('active');
      submitBtn.disabled = true;

      // Submit to backend
      google.script.run
        .withSuccessHandler(handleSuccess)
        .withFailureHandler(handleError)
        .saveBrokerSubmission(token, brokerData);
    }

    function handleSuccess(result) {
      const loading = document.getElementById('loading');
      const form = document.getElementById('brokerForm');

      loading.classList.remove('active');

      if (result.success) {
        showMessage('success', '‚úÖ Selvedge details submitted successfully! You may close this page.');
        form.style.display = 'none';
      } else {
        showMessage('error', '‚ùå Error: ' + (result.error || 'Unknown error'));
        document.getElementById('submitBtn').disabled = false;
      }
    }

    function handleError(error) {
      const loading = document.getElementById('loading');

      loading.classList.remove('active');
      showMessage('error', '‚ùå Error: ' + error.message);
      document.getElementById('submitBtn').disabled = false;
    }

    function showMessage(type, text) {
      const msg = document.getElementById('message');
      msg.className = 'message ' + type + ' active';
      msg.textContent = text;

      // Auto-scroll to message
      msg.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  </script>

</body>

</html>